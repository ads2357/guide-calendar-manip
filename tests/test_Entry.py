import pytest
import array

from guidediary import Entry

TEST_FILENAME = 'Appointments.gcal'

def test_parseEntries(tmpdir_factory):
    f = tmpdir_factory.mktemp('data').join(TEST_FILENAME)
    with open(str(f), 'wb') as ff:
        ff.write(get_sample_data())
    with open(str(f), 'rb') as ff:
        entries = Entry.parseEntries(ff)
    assert len(entries) == 1, "Expected a single entry"
    entry = entries[0]
    assert entry.text.strip() == "123 TESTING"

def get_sample_data():
    def to_bytes(s):
        str_flat = s.replace(" ","")
        str_numbers = (str_flat[ii:ii+1+1] for ii in range(0, len(str_flat), 2))
        return array.array(
            'B',
            (int(n, 16) for n in str_numbers)
        ).tobytes()

    return to_bytes(
        "e207 0000 0800 0000 1800 0000 0200 0000 "  # 00000000
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000010
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000020
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000030
        "2020 3132 3320 5445 5354 494e 4720 2020 " + # 00000040
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000050
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000060
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000070
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000080
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000090
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000000a0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000000b0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000000c0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000000d0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000000e0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000000f0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000100
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000110
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000120
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000130
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000140
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000150
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000160
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000170
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000180
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000190
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000001a0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000001b0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000001c0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000001d0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000001e0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 000001f0
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000200
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000210
        "2020 2020 2020 2020 2020 2020 2020 2020 " + # 00000220
        "2020 2020 2020 0100 0000 0000 0000 0000 " # + 00000230
    )
